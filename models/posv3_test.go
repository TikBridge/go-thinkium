package models

import (
	"encoding/hex"
	"testing"
)

func TestParseReportInput(t *testing.T) {
	ss := []string{
		"f81ba7cb0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000403833762f08a014e8effe7291ec32bca9448b7fb6566283827173d40bd5a66f58c7e57c897c2fb473ce77b25059e01e7e432a268096eed0c2bfec37839b33a601",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000bf000000000000000000000000000000000000000000000000000000000000004079d260d785858034d64641b9a5867bd08e3f6cae9a3f18e09dfd1a238808b97093d74a8f1a15d9cbab68b005383a2637cce73110f3dfb5faea0a7c371f0976b9",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c4000000000000000000000000000000000000000000000000000000000000004096dc94580e0eadd78691807f6eac9759b9964daa8b46da4378902b040e0eb102cb48413308d2131e9e5557321f30ba9287794f689854e6d2e63928a082e79286",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c20000000000000000000000000000000000000000000000000000000000000040975cea3906ea4f4f2cab617f05a89d70b96f99d8c18747050bb93ab885cc546a2af022ff480101f017885f6b9511e4e1e2a1e4dc533ea30f88b294e34c275767",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000409855b69ea2ff6b419de14b2ba18910e2427d251a3ffa453d9307a01dbabc213ef08cfad7459538dac14407046048bdd9f936ba317708b3f07a62782a2be6cca7",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c60000000000000000000000000000000000000000000000000000000000000040a93b150f11c422d8700554859281be8e34a91a859e0e021af186002c7e4a2661ea2467a63b417030d68e2fdddeb4342943dff13225da77124abf912fd092f71f",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000bf0000000000000000000000000000000000000000000000000000000000000040d0c7107542af7e0019e1340a77a00131d60f49f5543de76b1d5768660e6d694b5dee3e206049bf0009d2859db0b7378240667d85eeb8138426efe9fd3568ebe3",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c20000000000000000000000000000000000000000000000000000000000000040d53eddbbb20a4bdd4d2ca39af0a9b7b90abdba10180c69096fa7d10e0b7ce79a413a53dae1a6686e72f00b10e0645b1819bf8063f32292b3a6eac1ba2d111cc8",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000bc0000000000000000000000000000000000000000000000000000000000000040eba6f895f3e955582f10fc0f19efee43e1d3c2ee4240eb6fe106aaa387e6357e2a6a82f21624a5c0ffd9b47d00ab984206baec8614ee4d8bab1bdabe0435fea2",
		"f81ba7cb000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000b90000000000000000000000000000000000000000000000000000000000000040f236c00e5c1fd175e2ecfe3ccc29dcf27caafe82d4f532b20b64e34b0bb1d132ffd5efaa8e3b2316ccf3f4d9b2112213b01c792f107bd0565be7ac3d506bf31f",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000003e8000000000000000000000000000000000000000000000000000000000000038d0000000000000000000000000000000000000000000000000000000000000040e90a151759bf070969aae664e00502bb08568c85a73874492a3ec480c5178d5da29c790896fc62106e32d172819dec94202ff90f3b7ba3e6adf38508bc58cf43",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000403224de0da639511fec588d2e28f4472476b1600d003a10e38e0456426337624aaecd6636e5ce7ff95fc10746471ce7b680f664ccbf17057ca18c761706afa391",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000404ce2edd98452036c804f3f2eeef157672be2ccf647369eb42eb49ab9f428821f9990efde3cf7f16e4c64616c10b673077f4278c6dd2fc6021da8ad0085a522a2",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000405e17128ba224a96d6e84be0c7f899febea26c55c78940610d78a0d22dbd0ab03cc3233491de0b5eb770dbf850b509bd191723df4fc40520bcbab565d46543d6e",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000c8000000000000000000000000000000000000000000000000000000000000004084385cc16d8e0a47909ee998d51370e5f56d7c85716e045c99760bedb180346da7d00b575ba23b76ffcd0969ae84e1e6b6943ec408f40b44825128577d8a895d",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000c80000000000000000000000000000000000000000000000000000000000000040eba6f895f3e955582f10fc0f19efee43e1d3c2ee4240eb6fe106aaa387e6357e2a6a82f21624a5c0ffd9b47d00ab984206baec8614ee4d8bab1bdabe0435fea2",
		"931042b300000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000003e40000000000000000000000000000000000000000000000000000000000000040e90a151759bf070969aae664e00502bb08568c85a73874492a3ec480c5178d5da29c790896fc62106e32d172819dec94202ff90f3b7ba3e6adf38508bc58cf43",
	}
	for _, s := range ss {
		input, _ := hex.DecodeString(s)
		if IsPosv3InputOf(Posv3ReportName, input) {
			ps := new(struct {
				Nid     []byte `abi:"nodeId"`
				Ntype   uint8  `abi:"nodeType"`
				ChainID uint32 `abi:"chainId"`
				Epoch   uint64 `abi:"epoch"`
				Era     uint64 `abi:"era"`
				Should  uint16 `abi:"should"`
				Actual  uint16 `abi:"actual"`
			})
			if err := Posv3Abi.UnpackInput(ps, Posv3ReportName, input[4:]); err != nil {
				t.Fatalf("%v", err)
			}
			t.Logf("%s(nodeId:%x nodeType:%d chainId:%d epoch:%d era:%d should:%d actual:%d)", Posv3ReportName,
				ps.Nid, ps.Ntype, ps.ChainID, ps.Epoch, ps.Era, ps.Should, ps.Actual)
		} else if IsPosv3InputOf(Posv3AuditedName, input) {
			ps := new(struct {
				Nid          []byte `abi:"nodeId"`
				Ntype        uint8  `abi:"nodeType"`
				ChainID      uint32 `abi:"chainId"`
				Epoch        uint64 `abi:"epoch"`
				Era          uint64 `abi:"era"`
				Should       uint16 `abi:"should"`
				Actual       uint16 `abi:"actual"`
				AuditedCount uint64 `abi:"auditedCount"`
			})
			if err := Posv3Abi.UnpackInput(ps, Posv3AuditedName, input[4:]); err != nil {
				t.Fatalf("%v", err)
			}
			t.Logf("%s(nodeId:%x nodeType:%d chainId:%d epoch:%d era:%d should:%d actual:%d auditedCount:%d)",
				Posv3AuditedName, ps.Nid, ps.Ntype, ps.ChainID, ps.Epoch, ps.Era, ps.Should, ps.Actual, ps.AuditedCount)
		} else {
			t.Fatalf("not a report")
		}
	}
}
